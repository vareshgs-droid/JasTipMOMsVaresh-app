<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jastip MOMsVARESH - Admin & Katalog</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel untuk JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #10b981; border-radius: 10px; }
        .modal-open { overflow: hidden; }
    </style>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect, useCallback, useRef } = React;

        // --- KONFIGURASI GLOBAL ---
        const USERS = [
            { username: 'superadmin', password: 'spvadmin', role: 'owner', label: 'Direktur/Owner' },
            { username: 'stafed', password: 'staf1', role: 'entry', label: 'Staf Entry Produk' },
            { username: 'staffa', password: 'StafKeu', role: 'finance', label: 'Staf Keuangan' },
        ];

        const DB_CONFIG = { 
            url: 'https://rqsbqpntzofynmudzchm.supabase.co', 
            key: 'sb_publishable_YJ1rZgEZ_8KQ3sOam99u-w_ThOQbVZz' 
        };

        // --- UTILITIES (DEFINED FIRST FOR SAFETY) ---
        function formatRupiah(val) {
            const number = Number(val) || 0;
            return 'Rp ' + number.toLocaleString('id-ID');
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return '-';
                return date.toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' });
            } catch (e) { return '-'; }
        }

        // --- SVG ICONS HELPER ---
        const Icon = ({ name, size = 24, className = "" }) => {
            const icons = {
                ShoppingBag: <><path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"/><line x1="3" x2="21" y1="6" y2="6"/><path d="M16 10a4 4 0 0 1-8 0"/></>,
                Home: <><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></>,
                Plane: <path d="M17.8 19.2 16 11l3.5-3.5C21 6 21.5 4 21 3c-1-.5-3 0-4.5 1.5L13 8 4.8 6.2c-.5-.1-.9.1-1.1.5l-.3.5c-.2.5-.1 1 .3 1.3L9 12l-2 3H4l-1 1 3 2 2 3 1-1v-3l3-2 3.5 5.3c.3.4.8.5 1.3.3l.5-.2c.4-.3.6-.7.5-1.2z"/>,
                Database: <><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M3 5V19A9 3 0 0 0 21 19V5"/><path d="M3 12A9 3 0 0 0 21 12"/></>,
                DollarSign: <><line x1="12" x2="12" y1="2" y2="22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></>,
                UserCheck: <><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><polyline points="16 11 18 13 22 9"/></>,
                Plus: <><line x1="12" x2="12" y1="5" y2="19"/><line x1="5" x2="19" y1="12" y2="12"/></>,
                Edit: <><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></>,
                Trash2: <><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></>,
                LogOut: <><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></>,
                Calculator: <><rect width="16" height="20" x="4" y="2" rx="2" ry="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></>,
                TrendingUp: <><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></>,
                TrendingDown: <><polyline points="23 18 13.5 8.5 8.5 13.5 1 6"/><polyline points="17 18 23 18 23 12"/></>,
                Calendar: <><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></>,
                MapPin: <><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></>,
                Receipt: <><path d="M4 2v20l2-1 2 1 2-1 2 1 2-1 2 1 2-1 2 1V2l-2 1-2-1-2 1-2-1-2 1-2-1-2 1-2-1Z"/><path d="M16 8H8"/><path d="M16 12H8"/><path d="M15 16H8"/></>,
                Lock: <><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></>,
                ChevronRight: <polyline points="9 18 15 12 9 6"/>,
                CheckCircle2: <><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="m9 12 2 2 4-4"/></>,
                Tag: <><path d="M12 2H2v10l9.29 9.29c.94.94 2.48.94 3.42 0l6.58-6.58c.94-.94.94-2.48 0-3.42L12 2Z"/><path d="M7 7h.01"/></>,
                FileText: <><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></>,
                User: <><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></>,
                Info: <><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></>,
                Circle: <circle cx="12" cy="12" r="10"/>
            };
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {icons[name] || <circle cx="12" cy="12" r="10"/>}
                </svg>
            );
        };

        // --- COMPONENTS ---
        const Card = ({ children, className = "" }) => (
            <div className={`bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden ${className}`}>{children}</div>
        );

        const SimpleBarChart = ({ label, value, total, colorClass }) => {
            const percentage = total > 0 ? Math.min(100, Math.round((value / total) * 100)) : 0;
            return (
                <div className="mb-4">
                    <div className="flex justify-between text-[10px] mb-1 font-black text-slate-500 uppercase tracking-widest">
                        <span>{label}</span>
                        <span>{percentage}% ({formatRupiah(value)})</span>
                    </div>
                    <div className="w-full bg-slate-100 rounded-full h-2">
                        <div className={`h-2 rounded-full transition-all duration-1000 ${colorClass}`} style={{ width: `${percentage}%` }}></div>
                    </div>
                </div>
            );
        };

        // --- MAIN APP ---
        function App() {
            const [isLoggedIn, setIsLoggedIn] = useState(false);
            const [currentUser, setCurrentUser] = useState(null);
            const [activeTab, setActiveTab] = useState('landing');
            const [activeModule, setActiveModule] = useState('summary');
            const [selectedTripId, setSelectedTripId] = useState(null);
            const [isLoading, setIsLoading] = useState(false);
            const [isSaving, setIsSaving] = useState(false);
            const [sidebarOpen, setSidebarOpen] = useState(false);
            const [isConnected, setIsConnected] = useState(false);

            const [trips, setTrips] = useState([]);
            const [products, setProducts] = useState([]);
            const [orders, setOrders] = useState([]);
            const [expenses, setExpenses] = useState([]);

            const [productModal, setProductModal] = useState({ open: false, type: 'add', data: null });
            const [tripModal, setTripModal] = useState({ open: false, type: 'add', data: null });
            const [financeModal, setFinanceModal] = useState({ open: false, type: 'order', mode: 'add', data: null });
            const [deleteConfirm, setDeleteConfirm] = useState({ open: false, table: '', id: null, label: '' });

            const [prodForm, setProdForm] = useState({ name: '', price_buy: 0, fee: 0, image_url: '', description: '' });
            const [tripForm, setTripForm] = useState({ title: '', city: '', status: 'open', date_start: '', date_end: '', deadline: '' });
            const [finForm, setFinForm] = useState({ customer_name: '', total: 0, category: 'Transport', description: '', amount: 0 });
            const [loginForm, setLoginForm] = useState({ username: '', password: '' });
            const [loginError, setLoginError] = useState('');

            const getHeaders = useCallback(() => ({
                'apikey': DB_CONFIG.key,
                'Authorization': `Bearer ${DB_CONFIG.key}`,
                'Content-Type': 'application/json',
                'Prefer': 'return=representation'
            }), []);

            const fetchData = useCallback(async (silent = false) => {
                if (!DB_CONFIG.url) return;
                if (!silent) setIsLoading(true);
                const headers = getHeaders();
                try {
                    const [resT, resP, resO, resE] = await Promise.all([
                        fetch(`${DB_CONFIG.url}/rest/v1/trips?select=*&order=id.desc`, { headers }),
                        fetch(`${DB_CONFIG.url}/rest/v1/products?select=*&order=id.desc`, { headers }),
                        fetch(`${DB_CONFIG.url}/rest/v1/orders?select=*&order=id.desc`, { headers }),
                        fetch(`${DB_CONFIG.url}/rest/v1/expenses?select=*&order=id.desc`, { headers })
                    ]);
                    const dataT = resT.ok ? await resT.json() : [];
                    const dataP = resP.ok ? await resP.json() : [];
                    setTrips(dataT);
                    setProducts(dataP.map(p => ({ ...p, image: p.image_url || 'https://placehold.co/400x400?text=Produk' })));
                    setOrders(resO.ok ? await resO.json() : []);
                    setExpenses(resE.ok ? await resE.json() : []);
                    if (dataT.length > 0 && selectedTripId === null) setSelectedTripId(dataT[0].id);
                    setIsConnected(true);
                } catch (e) { console.error(e); } finally { if (!silent) setIsLoading(false); }
            }, [getHeaders, selectedTripId]);

            useEffect(() => { fetchData(true); }, []);

            const supabaseRequest = async (table, method, body, id = null) => {
                setIsSaving(true);
                try {
                    let url = `${DB_CONFIG.url}/rest/v1/${table}`;
                    if (id) url += `?id=eq.${id}`;
                    const res = await fetch(url, { method, headers: getHeaders(), body: body ? JSON.stringify(body) : undefined });
                    if (!res.ok) throw new Error("Database error");
                    await fetchData(true);
                    return true;
                } catch (e) { alert(e.message); return false; } finally { setIsSaving(false); }
            };

            const handleSaveProduct = async (e) => {
                e.preventDefault();
                const payload = { ...prodForm, price_sell: Number(prodForm.price_buy) + Number(prodForm.fee), trip_id: selectedTripId };
                if (await supabaseRequest('products', productModal.type === 'edit' ? 'PATCH' : 'POST', payload, productModal.data?.id)) 
                    setProductModal({ ...productModal, open: false });
            };

            const handleSaveTrip = async (e) => {
                e.preventDefault();
                if (await supabaseRequest('trips', tripModal.type === 'edit' ? 'PATCH' : 'POST', tripForm, tripModal.data?.id)) 
                    setTripModal({ ...tripModal, open: false });
            };

            const handleSaveFinance = async (e) => {
                e.preventDefault();
                const isOrder = financeModal.type === 'order';
                const body = isOrder ? { customer_name: finForm.customer_name, total: finForm.total, trip_id: selectedTripId, status: 'paid' } 
                                     : { category: finForm.category, description: finForm.description, amount: finForm.amount, trip_id: selectedTripId };
                if (await supabaseRequest(isOrder ? 'orders' : 'expenses', financeModal.mode === 'edit' ? 'PATCH' : 'POST', body, financeModal.data?.id))
                    setFinanceModal({ ...financeModal, open: false });
            };

            const processDelete = async () => {
                if (await supabaseRequest(deleteConfirm.table, 'DELETE', null, deleteConfirm.id))
                    setDeleteConfirm({ ...deleteConfirm, open: false });
            };

            const activeTripData = useMemo(() => trips.find(t => t.id === selectedTripId) || trips[0] || {}, [trips, selectedTripId]);
            const filteredProducts = products.filter(p => p.trip_id === selectedTripId);
            const stats = useMemo(() => {
                const rev = orders.filter(o => o.trip_id === selectedTripId).reduce((s, o) => s + (o.total || 0), 0);
                const exp = expenses.filter(e => e.trip_id === selectedTripId).reduce((s, e) => s + (e.amount || 0), 0);
                return { revenue: rev, expenses: exp, profit: rev - exp };
            }, [orders, expenses, selectedTripId]);

            const canAccess = (mod) => {
                if (!currentUser) return false;
                if (currentUser.role === 'owner') return true;
                if (currentUser.role === 'entry') return ['products', 'trips'].includes(mod);
                if (currentUser.role === 'finance') return ['finance', 'summary'].includes(mod);
                return false;
            };

            const handleLogin = (e) => {
                e.preventDefault();
                const user = USERS.find(u => u.username.toLowerCase() === loginForm.username.toLowerCase() && u.password === loginForm.password);
                if (user) {
                    setCurrentUser(user);
                    setIsLoggedIn(true);
                    setActiveTab('dashboard');
                    setActiveModule(user.role === 'entry' ? 'products' : user.role === 'finance' ? 'finance' : 'summary');
                    setLoginError('');
                } else {
                    setLoginError('Username atau Password salah!');
                }
            };

            const handleLogout = () => {
                setIsLoggedIn(false);
                setCurrentUser(null);
                setActiveTab('landing');
            };

            const openProdModal = (type, prod = null) => {
                setProductModal({ open: true, type, data: prod });
                if (type === 'edit' && prod) setProdForm({ name: prod.name, price_buy: prod.price_buy, fee: prod.fee || 0, image_url: prod.image_url, description: prod.description || '' });
                else setProdForm({ name: '', price_buy: 0, fee: 0, image_url: '', description: '' });
            };

            const openTripModal = (type, trip = null) => {
                setTripModal({ open: true, type, data: trip });
                if (type === 'edit' && trip) setTripForm({ title: trip.title, city: trip.city, status: trip.status || 'open', date_start: trip.date_start, date_end: trip.date_end, deadline: trip.deadline });
                else setTripForm({ title: '', city: '', status: 'open', date_start: '', date_end: '', deadline: '' });
            };

            const openFinModal = (type, mode = 'add', data = null) => {
                setFinanceModal({ open: true, type, mode, data });
                if (mode === 'edit' && data) {
                    if (type === 'order') setFinForm({ customer_name: data.customer_name, total: data.total });
                    else setFinForm({ category: data.category, description: data.description, amount: data.amount });
                } else setFinForm({ customer_name: '', total: 0, category: 'Transport', description: '', amount: 0 });
            };

            const confirmDelete = (table, id, label) => setDeleteConfirm({ open: true, table, id, label });

            // --- PUBLIC VIEW ---
            if (activeTab === 'landing') return (
                <div className="min-h-screen flex flex-col">
                    <nav className="bg-white px-6 py-4 shadow-sm flex justify-between items-center sticky top-0 z-30">
                        <div className="flex items-center gap-2 font-black text-slate-800"><Icon name="ShoppingBag" className="text-emerald-600"/> <span className="italic uppercase">MomsVaresh</span></div>
                        <button onClick={() => setActiveTab('dashboard')} className="text-[10px] font-black bg-slate-100 px-4 py-2 rounded-full uppercase tracking-widest">Login Admin</button>
                    </nav>
                    <div className="bg-emerald-600 text-white py-16 text-center relative overflow-hidden">
                        <h1 className="text-4xl font-black italic uppercase mb-2">Jastip MOMsVARESH</h1>
                        <p className="opacity-80 text-sm font-bold uppercase tracking-widest mb-8">Amanah & Terpercaya Se-Indonesia</p>
                        <div className="inline-block bg-white/10 backdrop-blur-lg p-6 rounded-3xl border border-white/20">
                            <div className="text-[10px] font-black uppercase opacity-60">Agenda PO</div>
                            <div className="text-xl font-black uppercase">{activeTripData.title || 'Menyiapkan...'}</div>
                            <div className="mt-2 text-[10px] font-black bg-white text-emerald-700 px-3 py-1 rounded-full inline-block uppercase">Batas PO: {formatDate(activeTripData.deadline)}</div>
                        </div>
                    </div>
                    <div className="max-w-7xl mx-auto px-6 py-12 flex-grow">
                        <div className="flex justify-between items-end mb-10">
                            <h2 className="text-2xl font-black italic uppercase tracking-tighter">Katalog Pilihan</h2>
                            <select className="border-2 rounded-xl p-2 text-xs font-black uppercase outline-none" value={selectedTripId || ''} onChange={e => setSelectedTripId(Number(e.target.value))}>
                                {trips.map(t => <option key={t.id} value={t.id}>{t.title}</option>)}
                            </select>
                        </div>
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-6">
                            {filteredProducts.map(p => (
                                <Card key={p.id} className="flex flex-col group h-full">
                                    <div className="aspect-square bg-slate-100 overflow-hidden relative border-b">
                                        <img src={p.image} className="w-full h-full object-cover group-hover:scale-110 transition duration-700" />
                                    </div>
                                    <div className="p-4 flex-1 flex flex-col">
                                        <h3 className="font-black uppercase text-sm mb-1 truncate">{p.name}</h3>
                                        <p className="text-[10px] text-slate-400 line-clamp-2 italic mb-4">{p.description || "Produk premium pilihan."}</p>
                                        <div className="mt-auto border-t pt-3">
                                            <div className="text-emerald-700 font-black text-xl italic">{formatRupiah(p.price_buy)}</div>
                                            <div className="text-[9px] text-orange-600 font-black uppercase mt-1">+ Jastip {formatRupiah(p.fee)}</div>
                                            <a href={`https://wa.me/628567176135?text=Halo MomsVaresh, saya mau titip *${p.name}*`} target="_blank" className="block w-full bg-emerald-600 text-white text-center py-3 rounded-xl font-black text-[10px] uppercase mt-4 shadow-lg active:scale-95 transition">Pesan Sekarang</a>
                                        </div>
                                    </div>
                                </Card>
                            ))}
                        </div>
                    </div>
                    <footer className="bg-slate-900 text-white py-12 text-center">
                        <div className="font-black italic text-2xl mb-2 uppercase">MOMsVARESH</div>
                        <p className="text-slate-500 text-[10px] font-black uppercase tracking-[0.4em]">Est 2026 â€¢ Indonesia</p>
                    </footer>
                </div>
            );

            // --- ADMIN LOGIN VIEW ---
            if (!isLoggedIn) return (
                <div className="min-h-screen bg-slate-900 flex items-center justify-center p-4">
                    <Card className="w-full max-w-md p-10 border-none shadow-2xl">
                        <div className="text-center mb-10"><Icon name="Lock" className="text-emerald-600 mx-auto mb-4" size={40}/><h2 className="text-3xl font-black text-slate-800 tracking-tighter uppercase">Admin Login</h2></div>
                        <form onSubmit={handleLogin} className="space-y-6">
                            <input className="w-full border-2 p-4 rounded-2xl font-black outline-none focus:ring-4 focus:ring-emerald-100 transition shadow-inner" placeholder="USERNAME" required value={loginForm.username} onChange={e => setLoginForm({...loginForm, username: e.target.value})} />
                            <input className="w-full border-2 p-4 rounded-2xl font-black outline-none focus:ring-4 focus:ring-emerald-100 transition shadow-inner" type="password" placeholder="PASSWORD" required value={loginForm.password} onChange={e => setLoginForm({...loginForm, password: e.target.value})} />
                            {loginError && <div className="text-red-500 text-xs font-black text-center italic">{loginError}</div>}
                            <button className="w-full bg-emerald-600 text-white py-5 rounded-2xl font-black shadow-xl hover:bg-emerald-700 active:scale-95 transition uppercase text-xs tracking-widest">Login</button>
                            <button type="button" onClick={() => setActiveTab('landing')} className="w-full text-slate-400 text-xs font-black uppercase tracking-widest text-center pt-2">Beranda</button>
                        </form>
                    </Card>
                </div>
            );

            // --- ADMIN PANEL VIEW ---
            return (
                <div className="flex min-h-screen bg-slate-100 font-sans">
                    {/* Sidebar */}
                    <div className="fixed inset-y-0 left-0 bg-slate-900 w-64 text-slate-300 flex flex-col shadow-2xl z-40">
                        <div className="p-8 border-b border-slate-800">
                            <div className="flex items-center gap-3 text-white font-black text-lg italic uppercase tracking-tighter"><Icon name="Database" size={20} className="text-emerald-600" /> MomsVaresh</div>
                            <div className="mt-4 text-[9px] font-black bg-emerald-500/10 text-emerald-400 border border-emerald-500/20 px-3 py-1.5 rounded-lg uppercase tracking-widest flex items-center gap-2 italic"><Icon name="UserCheck" size={12}/> {currentUser?.label}</div>
                        </div>
                        <nav className="p-4 flex-1 space-y-1">
                            {canAccess('summary') && <button onClick={() => setActiveModule('summary')} className={`w-full flex items-center gap-4 px-4 py-4 rounded-xl font-black text-xs uppercase tracking-widest transition ${activeModule === 'summary' ? 'bg-emerald-600 text-white' : 'hover:bg-slate-800'}`}><Icon name="Home" size={16}/> Dashboard</button>}
                            {canAccess('trips') && <button onClick={() => setActiveModule('trips')} className={`w-full flex items-center gap-4 px-4 py-4 rounded-xl font-black text-xs uppercase tracking-widest transition ${activeModule === 'trips' ? 'bg-emerald-600 text-white' : 'hover:bg-slate-800'}`}><Icon name="Plane" size={16}/> Agenda Trip</button>}
                            {canAccess('products') && <button onClick={() => setActiveModule('products')} className={`w-full flex items-center gap-4 px-4 py-4 rounded-xl font-black text-xs uppercase tracking-widest transition ${activeModule === 'products' ? 'bg-emerald-600 text-white' : 'hover:bg-slate-800'}`}><Icon name="ShoppingBag" size={16}/> Produk</button>}
                            {canAccess('finance') && <button onClick={() => setActiveModule('finance')} className={`w-full flex items-center gap-4 px-4 py-4 rounded-xl font-black text-xs uppercase tracking-widest transition ${activeModule === 'finance' ? 'bg-emerald-600 text-white' : 'hover:bg-slate-800'}`}><Icon name="DollarSign" size={16}/> Keuangan</button>}
                        </nav>
                        <div className="p-4 border-t border-slate-800 space-y-4">
                            <button onClick={handleLogout} className="w-full flex items-center justify-center gap-3 bg-red-500/10 text-red-400 border-2 border-red-500/20 py-3 rounded-xl font-black text-[10px] uppercase tracking-widest active:scale-95 transition">Logout</button>
                            <div className={`flex items-center gap-2 px-3 py-2 rounded-lg border text-[9px] font-black uppercase tracking-widest transition-all ${isConnected ? 'border-emerald-500/30 text-emerald-500 bg-emerald-500/5' : 'border-red-500/30 text-red-500 bg-red-500/5'}`}>
                                <div className={`w-2 h-2 rounded-full ${isConnected ? 'bg-emerald-500 animate-pulse' : 'bg-red-500'}`}></div>
                                {isConnected ? 'Cloud Connected' : 'Offline'}
                            </div>
                        </div>
                    </div>

                    <main className="flex-1 ml-64 p-10 overflow-y-auto">
                        <div className="flex justify-between items-center mb-10">
                            <h2 className="text-4xl font-black italic uppercase tracking-tighter">{activeModule}</h2>
                            <div className="bg-white p-2 rounded-2xl shadow-sm border flex items-center gap-4">
                                <span className="text-[10px] font-black uppercase ml-4 text-slate-400 tracking-widest">Agenda:</span>
                                <select className="bg-slate-50 rounded-xl px-4 py-3 text-xs font-black uppercase outline-none min-w-[200px]" value={selectedTripId || ''} onChange={e => setSelectedTripId(Number(e.target.value))}>
                                    {trips.map(t => <option key={t.id} value={t.id}>{t.title}</option>)}
                                </select>
                            </div>
                        </div>

                        {/* Modules */}
                        {activeModule === 'summary' && (
                            <div className="space-y-8 animate-in fade-in duration-500">
                                <div className="grid grid-cols-2 gap-6">
                                    <Card className="p-10 border-none shadow-xl bg-emerald-600 text-white italic"><div className="text-[10px] font-black uppercase opacity-60 mb-2 tracking-widest">Omzet</div><div className="text-5xl font-black italic">{formatRupiah(stats.revenue)}</div></Card>
                                    <Card className="p-10 border-none shadow-xl bg-blue-600 text-white italic"><div className="text-[10px] font-black uppercase opacity-60 mb-2 tracking-widest">Profit</div><div className="text-5xl font-black italic">{formatRupiah(stats.profit)}</div></Card>
                                </div>
                                <Card className="p-10 rounded-3xl border-none shadow-lg">
                                    <h3 className="font-black italic uppercase text-lg mb-8 flex items-center gap-3 italic"><Icon name="Calculator" className="text-emerald-600" size={28}/> Analisis Trip</h3>
                                    <SimpleBarChart label="Pendapatan" value={stats.revenue} total={stats.revenue} colorClass="bg-emerald-500" />
                                    <SimpleBarChart label="Operasional" value={stats.expenses} total={stats.revenue} colorClass="bg-red-400" />
                                </Card>
                            </div>
                        )}

                        {activeModule === 'trips' && (
                            <div className="space-y-6 animate-in slide-in-from-bottom-6">
                                <div className="flex justify-end"><button onClick={() => openTripModal('add')} className="bg-emerald-600 text-white px-8 py-4 rounded-2xl font-black text-xs uppercase shadow-xl hover:bg-emerald-700 active:scale-95 transition flex items-center gap-3"><Icon name="Plus" size={18}/> Agenda Baru</button></div>
                                <div className="grid gap-4">
                                    {trips.map(t => (
                                        <Card key={t.id} className="p-8 flex justify-between items-center group hover:border-emerald-500 transition-all rounded-3xl border-2">
                                            <div className="flex items-center gap-8">
                                                <div className="bg-emerald-50 text-emerald-600 p-5 rounded-2xl shadow-inner"><Icon name="Plane" size={32}/></div>
                                                <div><div className="font-black uppercase italic text-2xl tracking-tighter">{t.title}</div><div className="text-[10px] font-black text-slate-400 uppercase flex gap-8 mt-1 tracking-widest italic"><span><Icon name="MapPin" size={12} className="inline mr-2"/>{t.city}</span><span><Icon name="Calendar" size={12} className="inline mr-2"/>{formatDate(t.date_start)}</span></div></div>
                                            </div>
                                            <div className="flex items-center gap-2">
                                                <button onClick={() => openTripModal('edit', t)} className="p-3 text-slate-400 hover:text-emerald-600 hover:bg-emerald-50 rounded-xl transition"><Icon name="Edit" size={24}/></button>
                                                <button onClick={() => confirmDelete('trips', t.id, t.title)} className="p-3 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded-xl transition"><Icon name="Trash2" size={24}/></button>
                                            </div>
                                        </Card>
                                    ))}
                                </div>
                            </div>
                        )}

                        {activeModule === 'products' && (
                            <div className="space-y-6 animate-in slide-in-from-bottom-6">
                                <div className="flex justify-between items-center bg-white p-8 rounded-3xl shadow-xl border italic uppercase font-black text-lg italic"><div>Kontrol Produk</div><button onClick={() => openProdModal('add')} className="bg-emerald-600 text-white px-8 py-4 rounded-2xl text-xs flex items-center gap-2 uppercase tracking-widest"><Icon name="Plus" size={16}/> Item</button></div>
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                                    {filteredProducts.map(p => (
                                        <Card key={p.id} className="p-6 flex items-center gap-6 group hover:border-emerald-500 transition-all rounded-[2.5rem] border-2">
                                            <img src={p.image} className="w-24 h-24 rounded-[1.5rem] object-cover shadow-xl group-hover:scale-110 transition duration-500" />
                                            <div className="flex-1 min-w-0 font-black italic uppercase text-base truncate">
                                                {p.name}
                                                <div className="text-[10px] border-t-2 pt-3 border-slate-50 uppercase tracking-tighter mt-3 space-y-1">
                                                    <div className="flex justify-between font-normal text-slate-400"><span>Beli:</span><span className="text-slate-700">{formatRupiah(p.price_buy)}</span></div>
                                                    <div className="flex justify-between font-normal text-slate-400"><span>Laba:</span><span className="text-orange-600">+{formatRupiah(p.fee)}</span></div>
                                                    <div className="flex justify-between text-emerald-700 mt-2 text-sm italic font-black pt-1 border-t"><span>TOTAL:</span><span>{formatRupiah(Number(p.price_buy) + Number(p.fee))}</span></div>
                                                </div>
                                            </div>
                                            <div className="flex flex-col gap-2 flex-shrink-0">
                                                <button onClick={() => openProdModal('edit', p)} className="p-3 text-slate-400 hover:text-blue-600 border border-slate-100 rounded-xl shadow-sm transition"><Icon name="Edit" size={22}/></button>
                                                <button onClick={() => confirmDelete('products', p.id, p.name)} className="p-3 text-slate-400 hover:text-red-600 border border-slate-100 rounded-xl shadow-sm transition"><Icon name="Trash2" size={22}/></button>
                                            </div>
                                        </Card>
                                    ))}
                                </div>
                            </div>
                        )}

                        {activeModule === 'finance' && (
                            <div className="grid grid-cols-2 gap-10 animate-in slide-in-from-bottom-6 italic uppercase font-black">
                                <div className="space-y-6">
                                    <div className="flex justify-between items-center bg-emerald-50 p-8 rounded-3xl border-2 border-emerald-100 text-xs tracking-widest italic"><span>Pesanan</span><button onClick={() => openFinModal('order', 'add')} className="bg-emerald-600 text-white p-2 rounded-xl active:scale-90 transition"><Icon name="Plus" size={24}/></button></div>
                                    {orders.filter(o => o.trip_id === selectedTripId).map(o => (
                                        <Card key={o.id} className="p-8 border-l-[10px] border-l-emerald-500 shadow-xl border-2 flex justify-between items-center rounded-3xl">
                                            <div><div className="text-xl tracking-tighter italic">{o.customer_name}</div><div className="text-[9px] text-slate-400 tracking-[0.2em]">{formatDate(o.created_at)}</div></div>
                                            <div className="flex items-center gap-6 flex-shrink-0"><div className="text-emerald-600 text-2xl font-black">{formatRupiah(o.total)}</div><div className="flex gap-1"><button onClick={() => openFinModal('order', 'edit', o)} className="text-slate-300 hover:text-blue-500 p-1 transition"><Icon name="Edit" size={18}/></button><button onClick={() => confirmDelete('orders', o.id, `Pesanan ${o.customer_name}`)} className="text-slate-300 hover:text-red-500 p-1 transition"><Icon name="Trash2" size={18}/></button></div></div>
                                        </Card>
                                    ))}
                                </div>
                                <div className="space-y-6">
                                    <div className="flex justify-between items-center bg-red-50 p-8 rounded-3xl border-2 border-red-100 text-xs tracking-widest italic"><span>Operasional</span><button onClick={() => openFinModal('expense', 'add')} className="bg-red-600 text-white p-2 rounded-xl active:scale-90 transition"><Icon name="Plus" size={24}/></button></div>
                                    {expenses.filter(e => e.trip_id === selectedTripId).map(e => (
                                        <Card key={e.id} className="p-8 border-l-[10px] border-l-red-500 shadow-xl border-2 flex justify-between items-center rounded-3xl">
                                            <div className="flex-1 min-w-0 mr-4 italic"><div className="text-xl truncate tracking-tighter italic">{e.description}</div><div className="text-[9px] text-red-400 opacity-70 tracking-widest">{e.category}</div></div>
                                            <div className="flex items-center gap-6 flex-shrink-0 font-black"><div className="text-red-600 text-2xl">({formatRupiah(e.amount)})</div><div className="flex gap-1"><button onClick={() => openFinModal('expense', 'edit', e)} className="text-slate-300 hover:text-blue-500 p-1 transition"><Icon name="Edit" size={18}/></button><button onClick={() => confirmDelete('expenses', e.id, e.description)} className="text-slate-300 hover:text-red-500 p-1 transition"><Icon name="Trash2" size={18}/></button></div></div>
                                        </Card>
                                    ))}
                                </div>
                            </div>
                        )}
                    </main>

                    {/* Modals with Scroll Fixed */}
                    {productModal.open && (
                        <div className="fixed inset-0 bg-black/80 z-[100] flex items-center justify-center p-4 backdrop-blur-md italic font-black uppercase">
                            <Card className="w-full max-w-lg p-10 rounded-[3.5rem] my-auto max-h-[90vh] overflow-y-auto italic italic italic border-none shadow-2xl">
                                <h3 className="text-3xl tracking-tighter italic italic italic mb-8 border-b-2 pb-6 flex items-center gap-5 italic italic italic italic">
                                    <Icon name="ShoppingBag" className="text-emerald-600" size={40}/> {productModal.type === 'add' ? 'Item Baru' : 'Update Item'}
                                </h3>
                                <form onSubmit={handleSaveProduct} className="space-y-6">
                                    <div className="space-y-1"><label className="text-[10px] text-slate-400 tracking-widest italic italic">Nama Barang</label><input className="w-full border-2 p-4 rounded-2xl font-black focus:ring-4 focus:ring-emerald-100 transition shadow-inner italic" required value={prodForm.name} onChange={e => setProdForm({...prodForm, name: e.target.value})} /></div>
                                    <div className="space-y-1"><label className="text-[10px] text-slate-400 tracking-widest italic italic">Deskripsi</label><textarea className="w-full border-2 p-4 rounded-2xl font-black shadow-inner italic text-sm" rows="2" value={prodForm.description} onChange={e => setProdForm({...prodForm, description: e.target.value})} /></div>
                                    <div className="grid grid-cols-2 gap-5">
                                        <div className="space-y-1"><label className="text-[10px] text-slate-400 tracking-widest italic italic">Beli</label><input className="w-full border-2 p-4 rounded-2xl font-black shadow-inner" type="number" required value={prodForm.price_buy} onChange={e => setProdForm({...prodForm, price_buy: e.target.value})} /></div>
                                        <div className="space-y-1"><label className="text-[10px] text-orange-600 tracking-widest italic italic">Laba</label><input className="w-full border-orange-200 border-2 p-4 rounded-2xl font-black bg-orange-50" type="number" required value={prodForm.fee} onChange={e => setProdForm({...prodForm, fee: e.target.value})} /></div>
                                    </div>
                                    <div className="bg-emerald-50 p-6 rounded-[2.5rem] flex items-center gap-6 text-emerald-800 border-2 border-emerald-100 shadow-inner font-black">
                                        <Icon name="Calculator" size={36} className="opacity-40" />
                                        <div className="flex-1"><div className="text-[9px] opacity-60 italic italic">Jual:</div><div className="text-3xl tracking-tighter leading-none italic italic italic italic">{formatRupiah(Number(prodForm.price_buy) + Number(prodForm.fee))}</div></div>
                                    </div>
                                    <div className="space-y-1"><label className="text-[10px] text-slate-400 tracking-widest italic italic">URL Gambar</label><input className="w-full border-2 p-4 rounded-2xl font-black shadow-inner text-[10px] text-slate-400" value={prodForm.image_url} onChange={e => setProdForm({...prodForm, image_url: e.target.value})} /></div>
                                    <div className="pt-6"><button disabled={isSaving} className="w-full bg-emerald-600 text-white py-5 rounded-2xl font-black shadow-xl flex justify-center items-center gap-3 tracking-[0.2em]">{isSaving ? <Loader2 className="animate-spin" size={20}/> : <Icon name="CheckCircle2" size={20}/>} Konfirmasi</button></div>
                                    <button type="button" onClick={() => setProductModal({ ...productModal, open: false })} className="w-full text-slate-400 text-xs italic tracking-widest uppercase">Batal</button>
                                </form>
                            </Card>
                        </div>
                    )}

                    {financeModal.open && (
                        <div className="fixed inset-0 bg-black/80 z-[100] flex items-center justify-center p-4 backdrop-blur-md italic font-black uppercase">
                            <Card className="w-full max-w-md p-10 rounded-[3.5rem] my-auto max-h-[90vh] overflow-y-auto border-none shadow-2xl">
                                <h3 className="text-3xl tracking-tighter mb-8 border-b-2 pb-6 italic italic">{financeModal.mode === 'edit' ? 'Update' : 'Entry'} {financeModal.type === 'order' ? 'Lunas' : 'Biaya'}</h3>
                                <form onSubmit={handleSaveFinance} className="space-y-6 italic">
                                    {financeModal.type === 'order' ? (
                                        <>
                                            <input className="w-full border-2 p-5 rounded-2xl font-black outline-none focus:ring-4 focus:ring-emerald-100 shadow-inner italic" placeholder="Nama Pelanggan" required value={finForm.customer_name} onChange={e => setFinForm({...finForm, customer_name: e.target.value})} />
                                            <input className="w-full border-2 p-5 rounded-2xl font-black outline-none focus:ring-4 focus:ring-emerald-100 text-emerald-700 text-4xl shadow-inner italic" type="number" placeholder="Rp" required value={finForm.total} onChange={e => setFinForm({...finForm, total: e.target.value})} />
                                        </>
                                    ) : (
                                        <>
                                            <div className="flex items-center gap-3 bg-slate-50 p-2 rounded-2xl border italic italic"><Tag className="text-slate-400 ml-2" size={18}/><select className="flex-1 bg-transparent border-none p-2 font-black outline-none uppercase text-xs" value={finForm.category} onChange={e => setFinForm({...finForm, category: e.target.value})}><option value="Transport">Bensin / Grab / Tiket</option><option value="Akomodasi">Hotel / Parkir</option><option value="Konsumsi">Makan Team</option><option value="Lainnya">Lainnya</option></select></div>
                                            <div className="flex items-center gap-3 bg-slate-50 p-2 rounded-2xl border italic italic"><FileText className="text-slate-400 ml-2" size={18}/><input className="flex-1 bg-transparent border-none p-2 font-black outline-none uppercase text-sm" placeholder="Keterangan Detail" required value={finForm.description} onChange={e => setFinForm({...finForm, description: e.target.value})} /></div>
                                            <input className="w-full border-2 p-5 rounded-2xl font-black text-red-600 text-4xl shadow-inner italic italic" type="number" placeholder="Rp" required value={finForm.amount} onChange={e => setFinForm({...finForm, amount: e.target.value})} />
                                        </>
                                    )}
                                    <div className="flex gap-4 pt-6 italic italic italic italic">
                                        <button type="button" onClick={() => setFinanceModal({ ...financeModal, open: false })} className="flex-1 bg-slate-100 text-slate-500 py-5 rounded-2xl font-black text-xs uppercase italic">Batal</button>
                                        <button disabled={isSaving} className={`flex-1 text-white py-5 rounded-2xl font-black text-xs shadow-xl ${financeModal.type === 'order' ? 'bg-emerald-600 shadow-emerald-500/30' : 'bg-red-600 shadow-red-500/30'}`}>Simpan</button>
                                    </div>
                                </form>
                            </Card>
                        </div>
                    )}

                    {tripModal.open && (
                        <div className="fixed inset-0 bg-black/80 z-[100] flex items-center justify-center p-4 backdrop-blur-md italic font-black uppercase">
                            <Card className="w-full max-w-lg p-10 rounded-[3.5rem] my-auto max-h-[90vh] overflow-y-auto italic border-none shadow-2xl">
                                <h3 className="text-3xl tracking-tighter mb-8 border-b-2 pb-6 flex items-center gap-4 italic italic italic"><Icon name="Plane" className="text-emerald-600" size={40}/> Agenda Trip</h3>
                                <form onSubmit={handleSaveTrip} className="space-y-6 italic italic italic">
                                    <input className="w-full border-2 p-5 rounded-2xl font-black shadow-inner" placeholder="Judul Agenda" required value={tripForm.title} onChange={e => setTripForm({...tripForm, title: e.target.value})} />
                                    <input className="w-full border-2 p-5 rounded-2xl font-black shadow-inner" placeholder="Kota Tujuan" required value={tripForm.city} onChange={e => setTripForm({...tripForm, city: e.target.value})} />
                                    <div className="grid grid-cols-2 gap-4 italic italic">
                                        <div><label className="text-[9px] opacity-60 ml-1">Berangkat</label><input type="date" className="w-full border-2 p-4 rounded-2xl font-black outline-none italic" value={tripForm.date_start} onChange={e => setTripForm({...tripForm, date_start: e.target.value})} /></div>
                                        <div><label className="text-[9px] opacity-60 ml-1 text-orange-600">Deadline</label><input type="date" className="w-full border-orange-200 border-2 p-4 rounded-2xl bg-orange-50 font-black shadow-inner italic" value={tripForm.deadline} onChange={e => setTripForm({...tripForm, deadline: e.target.value})} /></div>
                                    </div>
                                    <div className="pt-6 flex gap-4 italic italic italic italic italic">
                                        <button type="button" onClick={() => setTripModal({ ...tripModal, open: false })} className="flex-1 bg-slate-100 text-slate-500 py-5 rounded-2xl font-black text-xs uppercase italic">Batal</button>
                                        <button disabled={isSaving} className="flex-1 bg-emerald-600 text-white py-5 rounded-2xl font-black text-xs uppercase shadow-xl active:scale-95 italic italic italic">Konfirmasi</button>
                                    </div>
                                </form>
                            </Card>
                        </div>
                    )}

                    {deleteConfirm.open && (
                        <div className="fixed inset-0 bg-black/95 z-[200] flex items-center justify-center p-6 backdrop-blur-xl animate-in fade-in zoom-in duration-300 italic font-black uppercase">
                            <Card className="w-full max-w-sm p-12 rounded-[3.5rem] text-center italic border-none shadow-2xl italic italic italic">
                                <div className="bg-red-100 w-24 h-24 rounded-3xl flex items-center justify-center mx-auto mb-8 shadow-2xl shadow-red-500/20 italic italic italic"><Icon name="Trash2" className="text-red-600" size={48} /></div>
                                <h3 className="text-3xl tracking-tighter mb-4 italic italic">Hapus Data?</h3>
                                <p className="text-slate-500 text-sm font-bold opacity-80 tracking-widest italic italic italic">{deleteConfirm.label}</p>
                                <div className="grid grid-cols-2 gap-5 mt-12 italic italic italic italic italic">
                                    <button onClick={() => setDeleteConfirm({ ...deleteConfirm, open: false })} className="bg-slate-100 py-5 rounded-2xl font-black text-xs uppercase">Batal</button>
                                    <button onClick={processDelete} disabled={isSaving} className="bg-red-600 text-white py-5 rounded-2xl font-black text-xs uppercase shadow-xl italic italic">Hapus</button>
                                </div>
                            </Card>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>